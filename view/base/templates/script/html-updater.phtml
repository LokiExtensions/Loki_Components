<script>
    const LokiHtmlReplacer = {
        replace(root, newRoot) {
            if (root.hasAttribute('x-ignore')) {
                return;
            }

            root.getAttributeNames().forEach(attributeName => {
                root.removeAttribute(attributeName);
            });

            newRoot.getAttributeNames().forEach(attributeName => {
                root.setAttribute(attributeName, newRoot.getAttribute(attributeName));
            });

            const incomingHTML = newRoot.innerHTML;
            const incomingFrag = this.parseHTML(incomingHTML);

            const existingSkips = root.querySelectorAll('[x-ignore]');
            existingSkips.forEach(oldEl => {
                const ancestor = oldEl.parentElement?.closest('[x-ignore]');
                if (ancestor && ancestor !== oldEl) {
                    return;
                }

                const path = this.pathFromRoot(root, oldEl);
                let counterpart = this.nodeByPath(incomingFrag, path);
                if (!counterpart) {
                    return;
                }

                if (!counterpart instanceof Element) {
                    return;
                }

                if (!counterpart.hasAttribute('x-ignore')) {
                    return;
                }

                counterpart.replaceWith(oldEl);
            });

            root.replaceChildren(...incomingFrag.childNodes);
        },

        parseHTML(html) {
            const tpl = document.createElement('template');
            tpl.innerHTML = String(html ?? '').trim();
            return tpl.content;
        },

        pathFromRoot(rootEl, el) {
            const path = [];
            let cur = el;
            while (cur && cur !== rootEl) {
                const parent = cur.parentNode;
                if (!parent) break;
                let idx = 0;
                for (let sib = parent.firstElementChild; sib; sib = sib.nextElementSibling) {
                    if (sib === cur) break;
                    idx++;
                }
                path.push(idx);
                cur = parent;
            }
            path.reverse();
            return path;
        },

        nodeByPath(rootLike, path) {
            let node = rootLike;
            for (const idx of path) {
                const children = (node instanceof DocumentFragment)
                    ? Array.from(node.children || node.childNodes).filter(n => n.nodeType === 1)
                    : node.children;
                node = children[idx];
                if (!node) return null;
            }
            return node;
        }
    };
</script>
